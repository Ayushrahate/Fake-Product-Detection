<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Product Detector</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        #loading-indicator {
            display: none;
            text-align: center;
        }
        #result-container {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        #image-preview-container {
            position: relative;
            margin-top: 1.5rem;
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #f9fafb;
        }
        #image-preview {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            display: none;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            pointer-events: none;
            font-size: 1rem;
            color: white;
            padding: 2px;
            font-weight: 700;
        }
        .bounding-box-label {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .real {
            border-color: #10b981;
        }
        .fake {
            border-color: #ef4444;
        }
        .neutral {
            border-color: #6366f1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

<div class="container">
    <h1 class="text-3xl font-bold text-center mb-6">Anti-Counterfeiting System</h1>
    <p class="text-center text-gray-600 mb-8">Upload a product image to check for authenticity. This application demonstrates the core concept of the research paper by simulating the detection process using a large language model.</p>

    <div class="flex flex-col items-center">
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        <button id="selectImageBtn" class="btn btn-primary mb-4 w-full sm:w-auto">Select Image</button>
        
        <div id="image-preview-container">
            <img id="image-preview" src="#" alt="Image Preview">
            <span id="placeholderText" class="text-gray-400">Your image preview will appear here.</span>
        </div>
        
        <button id="detectBtn" class="btn btn-primary mt-6 w-full sm:w-auto" disabled>Detect Product</button>
    </div>

    <div id="loading-indicator" class="mt-8">
        <p class="text-gray-500">Processing image... Please wait.</p>
    </div>

    <div id="result-container">
        <h2 class="text-2xl font-semibold mb-4">Detection Result</h2>
        <div id="result-content" class="text-lg"></div>
    </div>
</div>

<script>
    // Constants for API and model
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
    const API_KEY = ""; // Canvas will provide this at runtime

    // DOM elements
    const selectImageBtn = document.getElementById('selectImageBtn');
    const imageInput = document.getElementById('imageInput');
    const detectBtn = document.getElementById('detectBtn');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const placeholderText = document.getElementById('placeholderText');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultContainer = document.getElementById('result-container');
    const resultContent = document.getElementById('result-content');

    let uploadedImageBase64 = null;

    // --- Event Listeners ---
    selectImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                placeholderText.style.display = 'none';
                uploadedImageBase64 = e.target.result.split(',')[1];
                detectBtn.disabled = false;
                resultContainer.style.display = 'none';
                // Clear any previous bounding boxes
                document.querySelectorAll('.bounding-box').forEach(box => box.remove());
            };
            reader.readAsDataURL(file);
        }
    });

    detectBtn.addEventListener('click', async () => {
        if (!uploadedImageBase64) {
            resultContent.innerHTML = '<p class="text-red-500">Please select an image first.</p>';
            return;
        }

        // Show loading state and hide button
        loadingIndicator.style.display = 'block';
        detectBtn.disabled = true;
        resultContainer.style.display = 'none';
        resultContent.innerHTML = '';

        try {
            await simulateDetection(uploadedImageBase64);
        } catch (error) {
            console.error('Error during detection:', error);
            resultContent.innerHTML = `<p class="text-red-500">An error occurred during detection. Please try again.</p>`;
            resultContainer.style.display = 'block';
        } finally {
            // Hide loading state and enable button
            loadingIndicator.style.display = 'none';
            detectBtn.disabled = false;
        }
    });

    // --- Core Logic ---
    async function simulateDetection(base64Image) {
        // This is where we simulate the machine learning model described in the paper.
        // Instead of a real trained model, we use the Gemini API to analyze the image.
        const prompt = `You are a product authenticity detector. Analyze the uploaded image.
        1. Identify the main brand or logo.
        2. Identify any serial numbers, barcodes, or text.
        3. Based on common counterfeiting patterns (e.g., blurry logos, misaligned text, bad colors), determine if the product appears authentic or fake.
        4. Provide the result in a JSON object with the following properties:
           - "status": "authentic", "likely fake", or "uncertain".
           - "message": A brief explanation of the findings.
           - "detections": An array of objects, each representing a detected feature. Each object should have "label" (e.g., "Logo", "Serial Number"), "verdict" ("authentic", "fake", or "unclear"), and "bbox" (an object with "x", "y", "width", "height" percentages relative to the image). Use 0-100 scale for bbox values. Create a few mock bounding boxes.

        Example JSON response:
        {
          "status": "authentic",
          "message": "The logo is sharp and the serial number is clear. Appears authentic.",
          "detections": [
            { "label": "Logo", "verdict": "authentic", "bbox": { "x": 10, "y": 20, "width": 30, "height": 15 } },
            { "label": "Serial Number", "verdict": "authentic", "bbox": { "x": 55, "y": 70, "width": 25, "height": 5 } }
          ]
        }
        Make up realistic bounding box values for the detected features. Do not add any text before or after the JSON.
        `;

        const payload = {
            contents: [{
                parts: [{
                    text: prompt
                }, {
                    inlineData: {
                        mimeType: "image/png",
                        data: base64Image
                    }
                }]
            }],
            generationConfig: {
                responseMimeType: "application/json"
            }
        };

        const maxRetries = 3;
        let attempts = 0;
        
        while (attempts < maxRetries) {
            try {
                const response = await fetch(API_URL + API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayResult(jsonResponse);
                    return;
                } else {
                    throw new Error("Invalid response format from API.");
                }
            } catch (error) {
                console.error(`Attempt ${attempts + 1} failed:`, error);
                attempts++;
                if (attempts < maxRetries) {
                    const delay = Math.pow(2, attempts) * 1000;
                    console.log(`Retrying in ${delay / 1000} seconds...`);
                    await new Promise(res => setTimeout(res, delay));
                } else {
                    throw error;
                }
            }
        }
    }

    function displayResult(data) {
        resultContainer.style.display = 'block';
        resultContent.innerHTML = '';
        
        // Display overall status
        let statusColor = '';
        let statusText = '';
        switch(data.status.toLowerCase()) {
            case 'authentic':
                statusColor = 'text-green-600';
                statusText = 'Authentic';
                break;
            case 'likely fake':
                statusColor = 'text-red-600';
                statusText = 'Likely Fake';
                break;
            case 'uncertain':
                statusColor = 'text-yellow-600';
                statusText = 'Uncertain';
                break;
            default:
                statusColor = 'text-gray-600';
                statusText = 'Unknown';
        }

        let summaryHtml = `
            <p class="text-2xl font-bold ${statusColor}">${statusText}</p>
            <p class="mt-2 text-gray-700">${data.message}</p>
            <h3 class="mt-4 text-xl font-semibold">Detected Features:</h3>
        `;
        
        // Draw bounding boxes on the image
        const imgWidth = imagePreview.offsetWidth;
        const imgHeight = imagePreview.offsetHeight;
        
        data.detections.forEach(detection => {
            const box = document.createElement('div');
            let boxClass = '';
            let boxLabelColor = '';
            
            switch(detection.verdict.toLowerCase()) {
                case 'authentic':
                    boxClass = 'real';
                    boxLabelColor = '#10b981';
                    break;
                case 'fake':
                    boxClass = 'fake';
                    boxLabelColor = '#ef4444';
                    break;
                default:
                    boxClass = 'neutral';
                    boxLabelColor = '#6366f1';
            }

            // Calculate position and size based on image dimensions and percentage values
            const x = (detection.bbox.x / 100) * imgWidth;
            const y = (detection.bbox.y / 100) * imgHeight;
            const width = (detection.bbox.width / 100) * imgWidth;
            const height = (detection.bbox.height / 100) * imgHeight;

            box.className = `bounding-box ${boxClass}`;
            box.style.left = `${x}px`;
            box.style.top = `${y}px`;
            box.style.width = `${width}px`;
            box.style.height = `${height}px`;

            const label = document.createElement('div');
            label.className = 'bounding-box-label';
            label.textContent = `${detection.label} (${detection.verdict})`;
            label.style.backgroundColor = boxLabelColor;
            label.style.top = `-25px`;
            label.style.left = `0`;

            box.appendChild(label);
            imagePreviewContainer.appendChild(box);

            summaryHtml += `
                <div class="mt-2">
                    <p class="font-medium">${detection.label}: <span class="text-sm font-normal text-gray-500">Verdict: <span class="${boxClass === 'real' ? 'text-green-500' : boxClass === 'fake' ? 'text-red-500' : 'text-indigo-500'}">${detection.verdict}</span></span></p>
                </div>
            `;
        });
        
        resultContent.innerHTML = summaryHtml;
    }
</script>

</body>
</html>

